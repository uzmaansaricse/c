<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pending Orders Management</title>
    <link rel="stylesheet" href="style.css">
    <script src="auth-check.js"></script>
    <script src="admin-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        background-color: #f4f4f9;
    }

    .sidebar {
        width: 250px;
        height: 100vh;
        background-color: #2c6e31;
        color: white;
        position: fixed;
        top: 0;
        left: 0;
        padding: 20px 0;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        overflow-y: auto;
    }

    .sidebar h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 22px;
    }

    .sidebar ul {
        list-style: none;
        padding: 0;
    }

    .sidebar ul li {
        margin: 10px 0;
    }

    .sidebar ul li a {
        display: block;
        padding: 12px 20px;
        text-decoration: none;
        color: white;
        font-size: 16px;
        transition: background-color 0.3s ease;
        border-radius: 5px;
    }

    .sidebar ul li a:hover {
        background-color: #3f8744;
    }

    .container {
        margin-left: 270px;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        margin: 20px;
        margin-left: 290px;
        border: 2px solid #2c6e31;
    }

    h1 {
        text-align: center;
        background: #2c6e31;
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .alert-section {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .danger-section {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .action-buttons {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
    }

    th, td {
        padding: 12px 15px;
        border-bottom: 1px solid #ddd;
        text-align: left;
    }

    th {
        background: #2c6e31;
        color: white;
        font-weight: bold;
    }

    .pending-old {
        background-color: #ffebee;
    }

    .pending-new {
        background-color: #fff3e0;
    }

    .delete-btn {
        background: #dc3545;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
    }

    .delete-btn:hover {
        background: #c82333;
    }

    .stats {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .stat-card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #2c6e31;
        text-align: center;
        min-width: 150px;
    }

    .stat-number {
        font-size: 24px;
        font-weight: bold;
        color: #2c6e31;
    }

    @media (max-width: 768px) {
        .container {
            margin-left: 0;
            margin: 10px;
        }
        .sidebar {
            position: relative;
            width: 100%;
            height: auto;
        }
    }
</style>
</head>

<body>
    <div class="sidebar">
        <h2>Admin Dashboard</h2>
        <ul>
         <li><a href="video and imag showAdmin.html"><i class="fa-solid fa-box"></i> News Box</a></li>
        <li><a href="BenerAdmin.html"><i class="fa-solid fa-bars-progress"></i> Manage Banner</a></li>
        <li><a href="manageusers.html"><i class="fa-solid fa-bars-progress"></i> Manage Users</a></li>
        <li><a href="AdminPendingOrdersSavenday.html"><i class="fa-solid fa-clock"></i> Pending Orders</a></li>
        <li><a href="admin-all-ordersWithUpdate.html"><i class="fa-solid fa-globe"></i> Manage Orders</a></li>
        <li><a href="orderAdmin-analytics.html"><i class="fa-solid fa-chart-line"></i> Order Analytics</a></li>
        <li><a href="book-upload.html"><i class="fa-solid fa-upload"></i> Book Upload</a></li>
        <li><a href="BookUpdate Admin.html"><i class="fa-solid fa-pen-to-square"></i> Book Update/Delete</a></li>
        <li><a href="uploadcsv.html"><i class="fa-solid fa-cloud-arrow-up"></i> Upload CSV</a></li>
        <li><a href="admin-contacts.html"><i class="fa-solid fa-envelope"></i> Manage Contact Us</a></li>
        <li><a href="admin-reviews.html"><i class="fa-solid fa-star"></i> Manage Book Review</a></li>
          <li><a href="index.html"><i class="fa-solid fa-headset"></i>Back to Website</a></li>
        <li><a href="Logout.html"><i class="fa-solid fa-headset"></i> Logout</a></li>
        </ul>
    </div>

    <div class="container">
        <h1>Pending Orders Management</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalPending">0</div>
                <div>Total Pending</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="oldPending">0</div>
                <div>Old (24h+)</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newPending">0</div>
                <div>Recent</div>
            </div>
        </div>

        <div class="alert-section">
            <h3>‚ö†Ô∏è Auto-Delete Information</h3>
            <p><strong>Pending orders are automatically deleted after 24 hours.</strong></p>
            <p>Orders with status "Pending" (payment failed/incomplete) will be removed from the system automatically.</p>
        </div>

        <div class="action-buttons">
            <button class="btn btn-info" onclick="loadPendingOrders()">üîÑ Refresh Orders</button>
            <button class="btn btn-danger" onclick="deleteOldPendingOrders()">üóëÔ∏è Delete Old Pending Orders (24h+)</button>
        </div>

        <div id="pendingOrdersContainer">
            <table>
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer Name</th>
                        <th>Phone</th>
                        <th>Total Amount</th>
                        <th>Created Date</th>
                        <th>Hours Pending</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center;">Loading pending orders...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allPendingOrders = [];

        function formatDate(isoDate) {
            const date = new Date(isoDate);
            return `${date.getDate().toString().padStart(2, '0')}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getFullYear()} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }

        function calculateHoursPending(createdAt) {
            const now = new Date();
            const created = new Date(createdAt);
            const diffMs = now - created;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            return diffHours;
        }

        async function loadPendingOrders() {
            try {
                const response = await fetch('/admin/orders');
                const allOrders = await response.json();
                
                // Filter only pending orders
                allPendingOrders = allOrders.filter(order => order.status === 'Pending');
                
                renderPendingOrders();
                updateStats();
                
            } catch (error) {
                console.error('Error loading pending orders:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load pending orders'
                });
            }
        }

        function renderPendingOrders() {
            const tbody = document.getElementById('ordersTableBody');
            
            if (allPendingOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No pending orders found</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            allPendingOrders.forEach(order => {
                const hoursPending = calculateHoursPending(order.createdAt);
                const isOld = hoursPending >= 24;
                const rowClass = isOld ? 'pending-old' : 'pending-new';
                
                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td>${order.orderId || order._id}</td>
                    <td>${order.deliveryDetails.fullName}</td>
                    <td>${order.deliveryDetails.mobile}</td>
                    <td>‚Çπ${order.totalPrice}</td>
                    <td>${formatDate(order.createdAt)}</td>
                    <td>${hoursPending}h ${isOld ? '‚ö†Ô∏è' : ''}</td>
                    <td><span style="color: orange; font-weight: bold;">Pending</span></td>
                    <td>
                        <button class="delete-btn" onclick="deleteSingleOrder('${order._id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStats() {
            const total = allPendingOrders.length;
            const old = allPendingOrders.filter(order => calculateHoursPending(order.createdAt) >= 24).length;
            const recent = total - old;
            
            document.getElementById('totalPending').textContent = total;
            document.getElementById('oldPending').textContent = old;
            document.getElementById('newPending').textContent = recent;
        }

        async function deleteSingleOrder(orderId) {
            try {
                const result = await Swal.fire({
                    title: 'Delete Order?',
                    text: 'This action cannot be undone!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/api/admin-delete-order/${orderId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: 'Order has been deleted successfully.'
                        });
                        loadPendingOrders(); // Refresh the list
                    } else {
                        throw new Error('Failed to delete order');
                    }
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to delete order'
                });
            }
        }

        async function deleteOldPendingOrders() {
            try {
                const oldOrders = allPendingOrders.filter(order => calculateHoursPending(order.createdAt) >= 24);
                
                if (oldOrders.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Old Orders',
                        text: 'No pending orders older than 24 hours found.'
                    });
                    return;
                }

                const result = await Swal.fire({
                    title: `Delete ${oldOrders.length} Old Orders?`,
                    text: 'This will delete all pending orders older than 24 hours!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, delete them!'
                });

                if (result.isConfirmed) {
                    const response = await fetch('/api/admin/delete-old-pending-orders', {
                        method: 'DELETE'
                    });

                    const data = await response.json();

                    if (response.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Deleted!',
                            text: `${data.deletedCount} old pending orders have been deleted.`
                        });
                        loadPendingOrders(); // Refresh the list
                    } else {
                        throw new Error('Failed to delete old orders');
                    }
                }
            } catch (error) {
                console.error('Error deleting old orders:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to delete old pending orders'
                });
            }
        }

        // Load orders when page loads
        window.onload = function() {
            loadPendingOrders();
            
            // Auto-refresh every 5 minutes
            setInterval(loadPendingOrders, 5 * 60 * 1000);
        };
    </script>
</body>
</html>
