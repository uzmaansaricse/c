<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login | Aravali Publication</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #0f9d58 0%, #1e5631 100%);
      min-height: 100vh;
      margin: 0;
    }
    .container {
      max-width: 400px;
      margin: 48px auto;
      background: #fff;
      padding: 36px 32px 32px 32px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      text-align: center;
    }
    .logo {
      width: 150px;
      height: 150px;
      margin-bottom: -10px;
      margin-top: -40px;
    }
    h2 {
      margin: 0 0 8px 0;
      font-size: 2rem;
      color: #1e5631;
    }
    .subtitle {
      color: #444;
      margin-bottom: 18px;
      font-size: 1.1rem;
    }
    input, button {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: linear-gradient(90deg, #ff7043 0%, #ffd600 100%);
      color: #222;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg, #ffd600 0%, #ff7043 100%);
    }
    .social-btn {
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .social-btn img {
      width: 22px;
      height: 22px;
    }
    .hidden { display: none; }
    .or-divider {
      margin: 18px 0 10px 0;
      display: flex;
      align-items: center;
      text-align: center;
      color: #888;
    }
    .or-divider span {
      flex: 1;
      height: 1px;
      background: #eee;
      margin: 0 8px;
    }
    #msg, #otp-msg { color: #c62828; margin-top: 8px; min-height: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <img src="img/aravali_publication-removebg-preview.png" alt="Aravali Logo" class="logo" />
    <h2>Login</h2>
    <div class="subtitle">Welcome to Aravali Publication</div>
    <div id="step1">
      <input type="text" id="identifier" placeholder="Enter Mobile Number or Email" />
      <button onclick="checkUserType()">Continue</button>
    </div>
    <div id="step2-otp" class="hidden">
      <p>Enter OTP sent to your phone/email</p>
      <input type="text" id="otp" maxlength="6" placeholder="Enter OTP" />
      <button onclick="verifyOtp()">Verify</button>
      <button onclick="resendOtp()">Resend OTP</button>
      <div id="otp-msg"></div>
    </div>
    <div class="or-divider"><span></span>or<span></span></div>
    <div id="g_id_onload"
     data-client_id="502694400131-c91lrq2ohh5m1tj7c50uto2mimtktp9p.apps.googleusercontent.com"
     data-context="signin"
     data-ux_mode="popup"
     data-login_uri="http://localhost:9000/api/auth/social-login"
     data-auto_prompt="false">
</div>

  <button class="social-btn" id="google-login-btn" type="button">
  <img
    src="images/google-icon-1.png"
    alt="Google Logo"
    width="20"
    height="20"
    style="vertical-align: middle; margin-right: 8px;"
  />
  Continue with Google
</button>

<button class="social-btn" id="fb-login-btn" type="button" title="Facebook login requires HTTPS and will not work on HTTP">
  <img
    src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png"
    alt="Facebook Logo"
    width="20"
    height="20"
    style="vertical-align: middle; margin-right: 8px;"
  />
  Continue with Facebook
</button>

    <div id="msg"></div>
  </div>

  <!-- Google & Facebook SDKs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js"></script>
  <script>
    let userRole = null;
    let identifierValue = "";

    function showStep(step) {
      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2-otp').classList.add('hidden');
      if (step === 'step1') document.getElementById('step1').classList.remove('hidden');
      if (step === 'step2-otp') document.getElementById('step2-otp').classList.remove('hidden');
    }

    async function checkUserType() {
      identifierValue = document.getElementById('identifier').value.trim();
      if (!identifierValue) {
        document.getElementById('msg').innerText = "Please enter mobile number or email.";
        return;0
      }
      document.getElementById('msg').innerText = "Checking...";
      const res = await fetch('/api/auth/check-user-type', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier: identifierValue })
      });
      const data = await res.json();
      userRole = data.role;
      if (userRole === "admin" || userRole === "user" || userRole === "not_found") {
        await sendOtp();
        showStep('step2-otp');
      } else {
        document.getElementById('msg').innerText = "Unknown error.";
      }
    }

    async function sendOtp() {
      document.getElementById('otp-msg').innerText = "Sending OTP...";
      const res = await fetch('/api/auth/send-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier: identifierValue })
      });
      const data = await res.json();
      document.getElementById('otp-msg').innerText = data.message || '';
    }

    async function verifyOtp() {
      const otp = document.getElementById('otp').value.trim();
      if (!otp) {
        document.getElementById('otp-msg').innerText = "Please enter OTP.";
        return;
      }
      document.getElementById('otp-msg').innerText = "Verifying...";
      const res = await fetch('/api/auth/verify-otp', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ identifier: identifierValue, otp })
      });
      const data = await res.json();
      if (data.token) {
        document.getElementById('otp-msg').innerText = "Login successful!";
        // Save token, role, and sessionToken as user object
        localStorage.setItem('token', data.token);
        if (data.sessionToken) {
          localStorage.setItem('sessionToken', data.sessionToken);
        }
        // Redirect based on role
        if (data.role === 'admin') {
          window.location.href = '/11Admin-panel.html';
        } else {
          window.location.href = '/index.html';
        }
      } else {
        document.getElementById('otp-msg').innerText = data.message || "Invalid OTP.";
      }
    }

    async function resendOtp() {
      await sendOtp();
    }

    // Google Sign-In
    window.onload = function() {
      google.accounts.id.initialize({
        client_id: '502694400131-c91lrq2ohh5m1tj7c50uto2mimtktp9p.apps.googleusercontent.com',
        callback: handleGoogleCredentialResponse
      });
      document.getElementById('google-login-btn').onclick = function() {
        google.accounts.id.prompt();
      };
    };
    function handleGoogleCredentialResponse(response) {
      // response.credential is the id_token
      fetch('/api/auth/social-login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ provider: 'google', socialToken: response.credential })
      })
      .then(res => res.json())
      .then(data => {
        if (data.token) {
          localStorage.setItem('token', data.token);
          if (data.sessionToken) {
            localStorage.setItem('sessionToken', data.sessionToken);
          }
          const redirectTarget = (data.role === 'admin') ? '/11Admin-panel.html' : '/index.html';
          window.location.href = redirectTarget;
        } else {
          document.getElementById('msg').innerText = data.message || "Google login failed.";
        }
      });
    }

    // Facebook SDK init and login
    window.fbAsyncInit = function() {
      FB.init({
        appId      : '2008218099974422', // <-- Replace with your Facebook App ID
        cookie     : true,
        xfbml      : true,
        version    : 'v19.0'
      });
    };
    document.getElementById('fb-login-btn').onclick = function() {
      FB.login(function(response) {
        if (response.authResponse) {
          const accessToken = response.authResponse.accessToken;
          fetch('/api/auth/social-login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ provider: 'facebook', socialToken: accessToken })
          })
          .then(res => res.json())
          .then(data => {
            if (data.token) {
              localStorage.setItem('token', data.token);
              if (data.sessionToken) {
                localStorage.setItem('sessionToken', data.sessionToken);
              }
              document.getElementById('msg').innerText = "Facebook login successful!";
              const redirectTarget = (data.role === 'admin') ? '/11Admin-panel.html' : '/index.html';
              window.location.href = redirectTarget;
            } else {
              document.getElementById('msg').innerText = data.message || "Facebook login failed.";
            }
          });
        } else {
          document.getElementById('msg').innerText = "Facebook login cancelled.";
        }
      }, {scope: 'email'});
    };

    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.token) {
      // User is not logged in, show login form
      document.getElementById('step1').classList.remove('hidden');
    } else {
      // User is already logged in, redirect based on role
      if (user.role === 'admin') {
        window.location.href = '/11Admin-panel.html';
      } else {
        window.location.href = '/index.html';
      }
    }
  </script>
  <script src="script.js"></script>
</body>
</html>
