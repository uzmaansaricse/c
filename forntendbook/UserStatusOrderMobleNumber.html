  <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Order Status</title>
    <link rel="icon" type="image/jpeg" href="images/favacon.jpeg">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
    }

    .wrapper {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      width: 220px;
      background-color: #2c6e31;
      color: white;
      padding: 20px 0;
      height: 100vh;
      position: sticky;
      top: 0;
      transition: transform 0.3s ease;
    }
    .sidebar h3 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.2rem;
      letter-spacing: 1px;
    }
    .sidebar a {
      display: block;
      color: white;
      text-decoration: none;
      padding: 12px 20px;
      transition: background 0.3s;
    }
    .sidebar a:hover {
      background-color: #3f8744;
    }

    /* Toggle Button for Mobile */
    .menu-toggle {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      font-size: 26px;
      background: #2c6e31;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 5px 10px;
      z-index: 1000;
      cursor: pointer;
    }

    /* Main Content */
    .container {
      flex: 1;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin: 40px;
      padding: 20px;
      border: 2px solid #2c6e31;
    }
    h1 {
      background-color: #2c6e31;
      color: white;
      padding: 10px;
      margin-bottom: 23px;
      width: 100%;
      text-align: center;
      font-size: 24px;
      border-radius: 0 0 5px 5px;
    }
    h2 {
      color: #333;
      margin-top: 20px;
      text-align: center;
    }
    input[type="text"] {
      padding: 10px;
      width: 250px;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      display: block;
    }
    button {
      padding: 10px 20px;
      background-color: #2c6e31;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      display: block;
      margin: auto;
    }
    button:hover {
      background-color: #45a049;
    }

    .table-container {
      max-width: 90%;
      margin: 30px auto 0;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      min-width: 600px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      font-size: 16px;
    }
    th {
      background-color: #f4f4f4;
      cursor: pointer;
      color: #333;
      font-weight: bold;
    }
    th:hover {
      background-color: #ddd;
    }
    
    /* Hover effects for order rows */
    #ordersTable tbody tr {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    #ordersTable tbody tr:hover {
      background-color: #e8f5e8;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(44, 110, 49, 0.15);
    }
    
    #ordersTable tbody tr:hover td {
      color: #2c6e31;
      font-weight: 500;
    }
    
    /* Hover effect for book images */
    #ordersTable tbody tr img:hover {
      transform: scale(1.1);
      transition: transform 0.2s ease;
    }
    
    .highlight {
      background-color: #fffae6;
    }
    .highlight:hover {
      background-color: #fff7cc;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
      .wrapper {
        flex-direction: column;
      }

      .sidebar {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        transform: translateX(-100%);
        z-index: 999;
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .sidebar.active h3 {
        margin-top: 50px;
      }
      .menu-toggle {
        display: block;
        width: 43px;
      }

      .container {
        margin: 80px 15px 15px;
        padding: 15px;
      }

      input[type="text"], button {
        width: 90%;
        font-size: 15px;
      }

      table {
        min-width: 100%;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 20px;
        padding: 8px;
        width: 92%;
      }

      h2 {
        font-size: 18px;
      }

      th, td {
        padding: 10px;
        font-size: 14px;
      }

      button {
        font-size: 14px;
      }

      input[type="text"] {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

  <!-- Toggle Button -->
  <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>

  <!-- Wrapper -->
  <div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <h3>My Account</h3>
      <a href="My profile.html">My Profile</a>
      <a href="UserStatusOrderMobleNumber.html">My Orders</a>
      <a href="Raiseissue.html">Raise Issue</a>
      <a href="Logout.html" id="logoutBtn">Logout</a>
    </div>

    <!-- Main Content -->
    <div class="container">
      <h1>Your Orders</h1>
      <div class="table-container">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Book Image</th>
              <th>Book Name</th>
              <th>Quantity</th>
              <th>Total Price</th>
              <th>Payment Status</th>
              <th>Status</th>
              <th>Order placed Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Orders will be populated here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Toggle sidebar for mobile
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    // Fetch user orders from backend API
    async function fetchUserOrders() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('You must be logged in to view your orders.');
          window.location.href = 'signup-login.html';
          return;
        }

        const sessionToken = localStorage.getItem('sessionToken');
        const url = sessionToken ? `/user-orders?sessionToken=${sessionToken}` : '/user-orders';
        const response = await fetch(url, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch orders: ' + response.statusText);
        }

        const orders = await response.json();
        populateOrdersTable(orders);
      } catch (error) {
        console.error('Error fetching orders:', error);
        alert('Error fetching orders. Please try again later.');
      }
    }

    // Populate orders table with data
    function populateOrdersTable(orders) {
      const tbody = document.querySelector('#ordersTable tbody');
      tbody.innerHTML = '';

      if (!orders || orders.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 8;
        td.textContent = 'No orders found.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      // Group orders by order ID to avoid duplicates
      const groupedOrders = {};
      orders.forEach(order => {
        const orderId = order.orderId || order._id;
        if (!groupedOrders[orderId]) {
          groupedOrders[orderId] = order;
        }
      });

      // Display grouped orders
      Object.values(groupedOrders).forEach(order => {
        // Flatten order by books
        order.books.forEach((bookItem, bookIndex) => {
          const tr = document.createElement('tr');

          // Book Image with click handler to open newbookDetelies.html with book id
          const bookImageTd = document.createElement('td');
          const img = document.createElement('img');
          img.src = bookItem.bookImage || bookItem.image || '';
          img.alt = bookItem.bookName || bookItem.title || 'Book Image';
          img.style.width = '50px';
          img.style.height = 'auto';
          img.style.cursor = 'pointer';
          img.addEventListener('click', (e) => {
            e.stopPropagation();
            window.open(`newbookDetelies.html?id=${bookItem.bookId || bookItem.id}`, '_blank');
          });
          bookImageTd.appendChild(img);
          tr.appendChild(bookImageTd);

          // Book Name
          const bookNameTd = document.createElement('td');
          bookNameTd.textContent = bookItem.bookName || bookItem.title || 'N/A';
          tr.appendChild(bookNameTd);

          // Quantity
          const quantityTd = document.createElement('td');
          quantityTd.textContent = bookItem.quantity || 'N/A';
          tr.appendChild(quantityTd);

          // Total Price (for this book item)
          const totalPriceTd = document.createElement('td');
          const price = bookItem.price || 0;
          const quantity = bookItem.quantity || 0;
          totalPriceTd.textContent = 'â‚¹' + (price * quantity).toFixed(2);
          tr.appendChild(totalPriceTd);

          // Payment Status
          const paymentStatusTd = document.createElement('td');
          const hasPayment = order.paymentId && order.paymentId.trim() !== '';
          paymentStatusTd.textContent = hasPayment ? 'Success' : 'Failed';
          paymentStatusTd.style.color = hasPayment ? '#28a745' : '#e74c3c';
          paymentStatusTd.style.fontWeight = 'bold';
          tr.appendChild(paymentStatusTd);

          // Order Status
          const statusTd = document.createElement('td');
          const statusDescriptions = {
            "Processing": "Processing your order.",
            "Pending": "Order is not yet confirmed/placed.",
            "Unshipped": "Order is confirmed/placed. It will be shipped and dispatched soon.",
            "Shipped": "Order is processed, ready to be handed over to courier service.",
            "Dispatched": "Order is dispatched to courier.",
            "Delivering": "Order is midway of delivery.",
            "Delivered": "Order has been delivered.",
            "Completed": "Order has been completed.",
            "Cancelled": "Order has been cancelled.",
            "Refunded": "Order has been refunded.",
            "Paid": "Order payment has been received.",
            "Incomplete": "Order payment is incomplete.",
            "Payment Failed": "Payment failed. Click 'Retry Payment' to complete your order."
          };
          statusTd.textContent = statusDescriptions[order.status] || order.status || 'Unknown Status';
          if (order.status === 'Payment Failed' || !hasPayment) {
            statusTd.style.color = '#e74c3c';
            statusTd.style.fontWeight = 'bold';
          }
          tr.appendChild(statusTd);     

          // Created At
          const createdAtTd = document.createElement('td');
          createdAtTd.textContent = new Date(order.createdAt).toLocaleDateString() || 'N/A';
          tr.appendChild(createdAtTd);

          // Action column
          const actionTd = document.createElement('td');
          actionTd.style.display = 'flex';
          actionTd.style.gap = '5px';
          actionTd.style.flexDirection = 'column';
          actionTd.style.alignItems = 'center';

          // Show invoice button only for successful payments (orders with paymentId)
          if (hasPayment && bookIndex === 0) {
            const invoiceBtn = document.createElement('button');
            invoiceBtn.textContent = 'ðŸ“„ Invoice';
            invoiceBtn.style.cssText = 'background: #ff6b35; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-bottom: 3px;';
            invoiceBtn.onclick = (e) => {
              e.stopPropagation();
              downloadInvoice(order);
            };
            actionTd.appendChild(invoiceBtn);
          }

          // Show retry payment button for failed orders
          if (!hasPayment || order.status === 'Payment Failed') {
            const retryBtn = document.createElement('button');
            retryBtn.textContent = 'Retry Payment';
            retryBtn.style.cssText = 'background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;';
            retryBtn.onclick = (e) => {
              e.stopPropagation();
              retryPayment(order._id, order.totalPrice);
            };
            actionTd.appendChild(retryBtn);
          }

          if (actionTd.children.length === 0) {
            actionTd.textContent = '-';
            actionTd.style.display = 'table-cell';
          }
          tr.appendChild(actionTd);

          // Add click handler on row to open b.html with order id as query param
          tr.addEventListener('click', () => {
            window.location.href = `b.html?orderId=${order._id}`;
          });

          tbody.appendChild(tr);
        });
      });
    }

    // Retry payment function
    async function retryPayment(orderId, amount) {
      try {
        // Get Razorpay key
        const keyResponse = await fetch('/api/get-razorpay-key');
        const keyData = await keyResponse.json();
        
        // Create new Razorpay order
        const orderResponse = await fetch('/api/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: amount * 100 }) // Convert to paise
        });
        const orderData = await orderResponse.json();

        if (orderData.orderId) {
          const rzp = new Razorpay({
            key: keyData.key,
            amount: orderData.amount,
            currency: "INR",
            order_id: orderData.orderId,
            handler: function (response) {
              // Payment success: update order with payment ID
              updateOrderPayment(orderId, response.razorpay_payment_id);
            },
            modal: {
              ondismiss: function () {
                Swal.fire({
                  icon: "info",
                  title: "Payment Cancelled",
                  text: "You can retry payment anytime from your orders page."
                });
              }
            }
          });
          rzp.open();
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Unable to initiate payment. Please try again."
          });
        }
      } catch (error) {
        console.error('Retry payment error:', error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Something went wrong. Please try again."
        });
      }
    }

    // Update order with successful payment
    async function updateOrderPayment(orderId, paymentId) {
      try {
        const response = await fetch('/api/update-order-payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderId, paymentId })
        });
        
        const result = await response.json();
        if (result.success) {
          Swal.fire({
            icon: "success",
            title: "Payment Successful!",
            text: "Your order has been confirmed."
          }).then(() => {
            fetchUserOrders(); // Refresh orders list
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: "Payment received but order update failed. Please contact support."
          });
        }
      } catch (error) {
        console.error('Order update error:', error);
        Swal.fire({
          icon: "error",
          title: "Error",
          text: "Payment received but order update failed. Please contact support."
        });
      }
    }

    // Download Invoice Function
    function downloadInvoice(order) {
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Generate invoice page
        generateInvoicePage(doc, order);
        
        // Save the PDF
        const fileName = `Invoice_${order.orderId || order._id}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(fileName);
        
        Swal.fire({
          icon: 'success',
          title: 'Invoice Downloaded!',
          text: 'Your invoice has been downloaded successfully.',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error generating invoice:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to generate invoice. Please try again.'
        });
      }
    }

    // Generate Invoice Page
    function generateInvoicePage(doc, order) {
      // Set proper margins for A4 page (210x297mm)
      const margin = 15; // 15mm margin on all sides
      const pageWidth = 210;
      const pageHeight = 297;
      const contentWidth = pageWidth - (2 * margin);
      
      // Header
      doc.setFontSize(30);
      doc.setFont(undefined, 'bold');
      doc.text('ARAVALI PUBLICATION', pageWidth/2, margin + 25, { align: 'center' });
      
      doc.setFontSize(24);
      doc.text('INVOICE', pageWidth/2, margin + 40, { align: 'center' });
      
      // Invoice details
      doc.setFontSize(15);
      doc.setFont(undefined, 'normal');
      doc.text(`Invoice #: INV-${order.orderId || order._id}`, margin, margin + 60);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, margin + 70);
      doc.text(`Order ID: ${order.orderId || order._id}`, margin, margin + 80);
      
      // Company details (right side)
      doc.text('ARAVALI PUBLICATION', margin + 105, margin + 60);
      doc.text('Plot number 1, Rajeev Nagar,', margin + 105, margin + 70);
      doc.text('Vidhyadhar Nagar Sector 3,', margin + 105, margin + 80);
      doc.text('Jaipur 302038', margin + 105, margin + 90);
      doc.text('Phone: 9351324018', margin + 105, margin + 100);
      doc.text('Email: ancp012@gmail.com', margin + 105, margin + 110);
      
      // Customer details
      doc.setFont(undefined, 'bold');
      doc.text('BILL TO:', margin, margin + 125);
      doc.setFont(undefined, 'normal');
      doc.text(order.deliveryDetails.fullName, margin, margin + 135);
      doc.text(order.deliveryDetails.address, margin, margin + 145);
      doc.text(`${order.deliveryDetails.city}, ${order.deliveryDetails.state}`, margin, margin + 155);
      doc.text(`PIN: ${order.deliveryDetails.pincode}`, margin, margin + 165);
      doc.text(`Phone: ${order.deliveryDetails.mobile}`, margin, margin + 175);
      if (order.deliveryDetails.email) {
        doc.text(`Email: ${order.deliveryDetails.email}`, margin, margin + 185);
      }
      
      // Items table
      const tableStartY = margin + 200;
      
      // Table headers
      doc.setFont(undefined, 'bold');
      doc.rect(margin, tableStartY, contentWidth, 8);
      doc.text('S.No', margin + 5, tableStartY + 5);
      doc.text('Description', margin + 25, tableStartY + 5);
      doc.text('Qty', margin + 100, tableStartY + 5);
      doc.text('Rate', margin + 120, tableStartY + 5);
      doc.text('Amount', margin + 145, tableStartY + 5);
      
      // Table rows
      doc.setFont(undefined, 'normal');
      let currentY = tableStartY + 8;
      let totalAmount = 0;
      
      order.books.forEach((book, index) => {
        const amount = book.price * book.quantity;
        totalAmount += amount;
        
        doc.rect(margin, currentY, contentWidth, 8);
        doc.text((index + 1).toString(), margin + 5, currentY + 5);
        const bookTitle = book.title || book.bookName || 'Book';
        doc.text(bookTitle.substring(0, 30), margin + 25, currentY + 5);
        doc.text(book.quantity.toString(), margin + 105, currentY + 5);
        doc.text(`Rs.${book.price}`, margin + 125, currentY + 5);
        doc.text(`Rs.${amount}`, margin + 150, currentY + 5);
        
        currentY += 8;
      });
      
      // Total
      doc.setFont(undefined, 'bold');
      doc.rect(margin, currentY, contentWidth, 8);
      doc.text('TOTAL', margin + 100, currentY + 5);
      doc.text(`Rs.${totalAmount}`, margin + 150, currentY + 5);
      
      // Payment Status
      currentY += 15;
      doc.setFontSize(13);
      doc.text('Payment Status: PAID', margin, currentY);
      doc.text(`Payment ID: ${order.paymentId || 'N/A'}`, margin, currentY + 10);
      
      // Footer
      doc.setFont(undefined, 'normal');
      doc.setFontSize(12);
      doc.text('Thank you for your business!', pageWidth/2, pageHeight - 30, { align: 'center' });
      doc.text('This is a computer generated invoice.', pageWidth/2, pageHeight - 20, { align: 'center' });
    }

    // On page load, fetch and display user orders
    window.addEventListener('DOMContentLoaded', () => {
      fetchUserOrders();
    });
  </script>
</body>
</html>
